#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
PDF Editor Pro - Advanced PDF Editor with Acrobat-like features
Versione professionale con funzionalit√† avanzate simili ad Adobe Acrobat DC
"""

from PySide6.QtWidgets import (QApplication, QMainWindow, QWidget, QVBoxLayout, QHBoxLayout,
                               QPushButton, QLabel, QMessageBox, QRadioButton, QDialog)
from PySide6.QtCore import Qt
from PySide6.QtGui import QFont
import sys
import os
from pathlib import Path

# Aggiungi il percorso src se necessario
current_dir = Path(__file__).parent
src_dir = current_dir / "src"
if src_dir.exists():
    sys.path.insert(0, str(src_dir))

# Import dei moduli avanzati
try:
    from acrobat_like_gui import AcrobatLikeGUI
    from advanced_pdf_editor import AdvancedPDFEditor
    from pdf_form_editor import FormEditorGUI
    from pdf_security import SecurityGUI
    from user_config import user_config
    
    ADVANCED_FEATURES = True
except ImportError as e:
    print(f"Alcune funzionalit√† avanzate non sono disponibili: {e}")
    # Fallback alla versione base
    from main import PDFEditor, main as basic_main
    try:
        from user_config import user_config
    except ImportError:
        user_config = None
    ADVANCED_FEATURES = False

def show_feature_selection():
    """Mostra la finestra di selezione delle funzionalit√†"""
    app = QApplication.instance()
    if app is None:
        app = QApplication(sys.argv)
    
    window = QDialog()
    window.setWindowTitle("PDF Editor Pro - Selezione Modalit√†")
    window.resize(600, 600)
    window.setStyleSheet("background-color: #f0f0f0;")
    
    # Centra la finestra
    screen_geometry = app.primaryScreen().geometry()
    x = (screen_geometry.width() - window.width()) // 2
    y = (screen_geometry.height() - window.height()) // 2
    window.move(x, y)
    
    # Menu bar
    menubar = tk.Menu(root)
    root.config(menu=menubar)
    
    # Menu File
    file_menu = tk.Menu(menubar, tearoff=0)
    menubar.add_cascade(label="File", menu=file_menu)
    
    def open_recent_file(file_path):
        """Apre un file recente nell'editor appropriato"""
        # Determina la modalit√† preferita
        default_mode = user_config.get("default_mode", "advanced") if user_config else "advanced"
        
        if default_mode == "advanced" and ADVANCED_FEATURES:
            root.destroy()
            advanced_root = tk.Tk()
            app = AcrobatLikeGUI(advanced_root)
            app.pdf_editor.open_pdf(file_path)
            advanced_root.mainloop()
        else:
            # Usa editor base
            root.destroy()
            basic_root = tk.Tk()
            # Qui dovremmo aprire il file nell'editor base
            basic_root.mainloop()
    
    # File recenti
    if user_config:
        recent_files = user_config.get_recent_files()
        if recent_files:
            recent_menu = tk.Menu(file_menu, tearoff=0)
            file_menu.add_cascade(label="File Recenti", menu=recent_menu)
            
            for file_path in recent_files:
                file_name = os.path.basename(file_path)
                recent_menu.add_command(
                    label=file_name,
                    command=lambda fp=file_path: open_recent_file(fp)
                )
            
            recent_menu.add_separator()
            recent_menu.add_command(
                label="Pulisci Lista",
                command=lambda: user_config.clear_recent_files()
            )
    
    file_menu.add_separator()
    file_menu.add_command(label="Esci", command=root.quit)
    
    # Menu Opzioni
    options_menu = tk.Menu(menubar, tearoff=0)
    menubar.add_cascade(label="Opzioni", menu=options_menu)
    
    def show_preferences():
        """Mostra finestra preferenze"""
        pref_window = tk.Toplevel(root)
        pref_window.title("Preferenze")
        pref_window.geometry("400x300")
        pref_window.configure(bg='#f0f0f0')
        
        # Modalit√† predefinita
        tk.Label(pref_window, text="Modalit√† predefinita:", 
                bg='#f0f0f0', font=('Arial', 10, 'bold')).pack(pady=10)
        
        mode_var = tk.StringVar(value=user_config.get("default_mode", "advanced") if user_config else "advanced")
        mode_frame = tk.Frame(pref_window, bg='#f0f0f0')
        mode_frame.pack(pady=5)
        
        tk.Radiobutton(mode_frame, text="Avanzato", variable=mode_var, value="advanced", bg='#f0f0f0').pack(side='left')
        tk.Radiobutton(mode_frame, text="Base", variable=mode_var, value="basic", bg='#f0f0f0').pack(side='left')
        tk.Radiobutton(mode_frame, text="Form", variable=mode_var, value="form", bg='#f0f0f0').pack(side='left')
        
        def save_preferences():
            if user_config:
                user_config.set("default_mode", mode_var.get())
            pref_window.destroy()
        
        tk.Button(pref_window, text="Salva", command=save_preferences,
                 bg='#3498db', fg='white', font=('Arial', 10, 'bold')).pack(pady=20)
    
    options_menu.add_command(label="Preferenze", command=show_preferences)
    
    # Menu Aiuto
    help_menu = tk.Menu(menubar, tearoff=0)
    menubar.add_cascade(label="Aiuto", menu=help_menu)
    
    def show_about():
        """Mostra informazioni sull'applicazione"""
        about_text = f"""PDF Editor Pro v2.0
        
Editor PDF professionale con funzionalit√† avanzate

Funzionalit√† disponibili:
{"‚úì Editor Avanzato (PyMuPDF)" if ADVANCED_FEATURES else "‚úó Editor Avanzato (non disponibile)"}
{"‚úì Editor Form" if ADVANCED_FEATURES else "‚úó Editor Form (non disponibile)"}
{"‚úì Sicurezza e Crittografia" if ADVANCED_FEATURES else "‚úó Sicurezza (non disponibile)"}
‚úì Editor Base

Sviluppato con Python e tkinter
¬© 2024 PDF Editor Pro"""
        
        messagebox.showinfo("Informazioni", about_text)
    
    help_menu.add_command(label="Informazioni", command=show_about)
    
    # Titolo
    title_label = tk.Label(root, text="PDF EDITOR PRO", 
                          font=('Arial', 20, 'bold'), bg='#f0f0f0', fg='#2c3e50')
    title_label.pack(pady=20)
    
    subtitle_label = tk.Label(root, text="Scegli la modalit√† di utilizzo", 
                             font=('Arial', 12), bg='#f0f0f0', fg='#666')
    subtitle_label.pack(pady=10)
    
    # Frame per le opzioni
    options_frame = tk.Frame(root, bg='#f0f0f0')
    options_frame.pack(expand=True, fill='both', padx=50, pady=20)
    
    def open_advanced_editor():
        """Apre l'editor avanzato tipo Acrobat"""
        # Salva preferenza utente
        if user_config:
            user_config.set("default_mode", "advanced")
        
        root.destroy()
        if ADVANCED_FEATURES:
            advanced_root = tk.Tk()
            app = AcrobatLikeGUI(advanced_root)
            advanced_root.mainloop()
        else:
            messagebox.showerror("Errore", "Funzionalit√† avanzate non disponibili")
    
    def open_basic_editor():
        """Apre l'editor base"""
        # Salva preferenza utente
        if user_config:
            user_config.set("default_mode", "basic")
        
        root.destroy()
        # Avvia l'editor base esistente
        try:
            import subprocess
            subprocess.run([sys.executable, "main.py"], cwd=current_dir)
        except Exception as e:
            messagebox.showerror("Errore", f"Impossibile avviare l'editor base: {e}")
    
    def open_form_editor():
        """Apre l'editor di form"""
        # Salva preferenza utente
        if user_config:
            user_config.set("default_mode", "form")
        
        root.destroy()
        if ADVANCED_FEATURES:
            form_root = tk.Tk()
            form_root.withdraw()  # Nascondi finestra principale
            
            # Crea editor PDF di base
            pdf_editor = AdvancedPDFEditor()
            
            # Apri PDF se necessario
            file_path = filedialog.askopenfilename(
                title="Apri PDF per editing form",
                filetypes=[("PDF files", "*.pdf")],
                initialdir=user_config.get("default_save_location") if user_config else None
            )
            
            if file_path:
                # Aggiungi ai file recenti
                if user_config:
                    user_config.add_recent_file(file_path)
                
                if pdf_editor.open_pdf(file_path):
                    form_gui = FormEditorGUI(form_root, pdf_editor)
                    form_gui.open_form_editor()
                    form_root.mainloop()
                else:
                    messagebox.showerror("Errore", "Impossibile aprire il PDF")
                    form_root.destroy()
            else:
                form_root.destroy()
        else:
            messagebox.showerror("Errore", "Funzionalit√† avanzate non disponibili")
    
    # Pulsante Editor Avanzato
    advanced_btn = tk.Button(options_frame, 
                           text="üéØ EDITOR AVANZATO\\n(Simile ad Adobe Acrobat)",
                           command=open_advanced_editor,
                           font=('Arial', 12, 'bold'),
                           bg='#3498db', fg='white',
                           width=35, height=3,
                           relief='raised', bd=2)
    advanced_btn.pack(pady=10)
    
    advanced_desc = tk.Label(options_frame, 
                           text="‚Ä¢ Editing visuale interattivo\\n‚Ä¢ Annotazioni e disegni\\n‚Ä¢ Pannelli laterali\\n‚Ä¢ Zoom avanzato",
                           font=('Arial', 9), bg='#f0f0f0', fg='#666',
                           justify='left')
    advanced_desc.pack(pady=5)
    
    # Pulsante Editor Base
    basic_btn = tk.Button(options_frame,
                         text="üìù EDITOR BASE\\n(Funzioni essenziali)",
                         command=open_basic_editor,
                         font=('Arial', 12, 'bold'),
                         bg='#27ae60', fg='white',
                         width=35, height=3,
                         relief='raised', bd=2)
    basic_btn.pack(pady=10)
    
    basic_desc = tk.Label(options_frame,
                         text="‚Ä¢ Unisci, dividi, ruota PDF\\n‚Ä¢ Estrai testo e pagine\\n‚Ä¢ Converti immagini\\n‚Ä¢ Watermark semplici",
                         font=('Arial', 9), bg='#f0f0f0', fg='#666',
                         justify='left')
    basic_desc.pack(pady=5)
    
    # Pulsante Editor Form
    if ADVANCED_FEATURES:
        form_btn = tk.Button(options_frame,
                           text="üìã EDITOR FORM\\n(Campi interattivi)",
                           command=open_form_editor,
                           font=('Arial', 12, 'bold'),
                           bg='#e74c3c', fg='white',
                           width=35, height=3,
                           relief='raised', bd=2)
        form_btn.pack(pady=10)
        
        form_desc = tk.Label(options_frame,
                           text="‚Ä¢ Crea campi di testo, checkbox\\n‚Ä¢ Radio button, dropdown\\n‚Ä¢ Gestione dati form\\n‚Ä¢ Validazione campi",
                           font=('Arial', 9), bg='#f0f0f0', fg='#666',
                           justify='left')
        form_desc.pack(pady=5)
    
    # Info versione
    version_frame = tk.Frame(root, bg='#f0f0f0')
    version_frame.pack(side='bottom', fill='x', pady=10)
    
    version_text = "PDF Editor Pro v2.0"
    if ADVANCED_FEATURES:
        version_text += " - Tutte le funzionalit√† disponibili"
    else:
        version_text += " - Modalit√† base"
        
    version_label = tk.Label(version_frame, text=version_text,
                           font=('Arial', 8), bg='#f0f0f0', fg='#888')
    version_label.pack()
    
    root.mainloop()

def main():
    """Funzione principale"""
    try:
        show_feature_selection()
    except Exception as e:
        print(f"Errore nell'avvio dell'applicazione: {e}")
        # Fallback all'editor base
        try:
            if ADVANCED_FEATURES:
                basic_main()
            else:
                root = tk.Tk()
                app = PDFEditor(root)
                root.mainloop()
        except Exception as e2:
            print(f"Errore anche nel fallback: {e2}")
            messagebox.showerror("Errore Critico", 
                               f"Impossibile avviare l'applicazione:\\n{e2}")

if __name__ == "__main__":
    main()